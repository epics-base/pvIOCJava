<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>EPICS JavaIOC: calculation support examples</title>
</head>

<body>
<h1 style="text-align: center">EPICS JavaIOC: support<br />
package: org.epics.ioc.support.calc.example<br />
2008.06.26</h1>
CONTENTS 

<div class="toc">
<ul>
  <li><a href="#Overview">Overview</a></li>
  <li><a href="#exampleCal">exampleCalculatorGenerate.xml</a></li>
  <li><a href="#exampleCal1">exampleCalculatorSupport.xml</a></li>
  <li><a href="#Generated">Generated Code</a>
    <ul>
      <li><a href="#CounterCal">CounterCalculatorFactory.java</a></li>
      <li><a href="#ArrayIncre">ArrayIncrementCalculatorFactory.java</a></li>
      <li><a
      href="#BooleanArr">BooleanArrayToggleCalculatorFactory.java</a></li>
      <li><a href="#ArrayAddCa">ArrayAddCalculatorFactory.java</a></li>
    </ul>
  </li>
</ul>
</div>
<hr />

<h2 style="text-align: center" id="Overview">Overview</h2>
<hr />

<p>This package has some example calculation modules generated by
XMLToCalcSupportFactory. The examples are:</p>
<dl>
  <dt>counter</dt>
    <dd>Has arguments named min, max, and inc. When process is called it adds
      inc to value. If the new value is greater than max, it is set to min.
      The value field must be a scalar double. </dd>
  <dt>arrayIncrement</dt>
    <dd>The value field must be an array of doubles. When process is called 1
      is added to each element of the array.</dd>
  <dt>booleanArrayToggle</dt>
    <dd>The value field must be an array of boolean. When process is called
      each array element is toggled between false and true. This if iot is
      false it is set to true and if true set to false.</dd>
  <dt>arrayAdd</dt>
    <dd>It has arguments named a and b. The fields a, b, and value must eac
      be a double array. When process is called it sets value equal to a +
    b.</dd>
</dl>

<p>The following interfaces are available:</p>
<dl>
  <dt>CalculatorSupport</dt>
    <dd>An extension for field calculations.</dd>
  <dt>CalcArgArraySupport</dt>
    <dd>An extension for the arguments for calculations;</dd>
</dl>

<p>The following abstract classes are provided for implementing support:</p>
<dl>
  <dt>AbstractCalculatorSupport</dt>
    <dd>A base class that is extended by code generated by
      XMLToCalcSupportFactory.</dd>
</dl>

<p>The following factories are provided:</p>
<dl>
  <dt>Calculation Support</dt>
    <dd>The following provides support for the array of structures for the
      arguments for calculations: 
      <dl>
        <dt>CalcArgArrayFactory</dt>
          <dd>Support for an array of arguments for calculation records.</dd>
      </dl>
    </dd>
    <dd>The following are calculations that are used for testing. They are
      examples of how to implement a calculation. 
      <dl>
        <dt>CounterCalculatorFactory</dt>
          <dd>Test code for a numeric field.</dd>
        <dt>ArrayIncrementCalculatorFactory</dt>
          <dd>Test code for numeric array fields.</dd>
        <dt>BooleanArrayToggleCalculatorFactory</dt>
          <dd>Test support for a boolean array.</dd>
      </dl>
    </dd>
</dl>
<hr />

<h2 style="text-align: center"
id="exampleCal">exampleCalculatorGenerate.xml</h2>
<hr />

<p>This is the xml file that is given to XMLToCalcSupportFactory.</p>
<pre>&lt;?xml version="1.0" ?&gt;
&lt;JavaIOCCalculation&gt;

&lt;calculate name = "counter"&gt;
  &lt;arg name = "min" type = "double" /&gt;
  &lt;arg name = "max" type = "double" /&gt;
  &lt;arg name = "inc" type = "double" /&gt;
  &lt;value type = "double" /&gt;
  &lt;compute&gt;
            value += inc;
            if(inc&amp;gt;0) {
                if(value&amp;gt;max) value = min;
                if(value&amp;lt;min) value = min;
            } else {
                if(value&amp;gt;min) value = max;
                if(value&amp;lt;max) value = max;
            }
  &lt;/compute&gt;
&lt;/calculate&gt;

&lt;calculate name = "arrayIncrement"&gt;
  &lt;value type = "array" elementType = "double" /&gt;
  &lt;compute&gt;
           for(int i=0; i&amp;lt;valueLength; i++) {
               value[i] = value[i] + 1.0;
           }
  &lt;/compute&gt;
&lt;/calculate&gt;

&lt;calculate name = "booleanArrayToggle"&gt;
  &lt;value type = "array" elementType = "boolean" /&gt;
  &lt;compute&gt;
             for(int i=0; i&amp;lt;valueLength; i++) {
                 value[i] = (value[i] ? false : true);
             }
  &lt;/compute&gt;
&lt;/calculate&gt;

&lt;calculate name = "arrayAdd"&gt;
  &lt;import packageName = "java.lang.Math" /&gt;
  &lt;arg name = "a" type = "array" elementType = "double" /&gt;
  &lt;arg name = "b" type = "array" elementType = "double" /&gt;
  &lt;value type = "array" elementType = "double" /&gt;
  &lt;compute&gt;
           int len = aLength;
           if(len&gt;bLength) len = bLength;
           if(valueLength!=len) {
               valueLength = len;
               valuePV.setLength(valueLength);
               valuePV.get(0,valueLength,valueData);
           }
           for(int i=0; i&amp;lt;valueLength; i++) {
               value[i] = Math.abs(a[i] + b[i]);
           }
  &lt;/compute&gt;
&lt;/calculate&gt;

&lt;/JavaIOCCalculation&gt;
</pre>
<hr />

<h2 style="text-align: center"
id="exampleCal1">exampleCalculatorSupport.xml</h2>
<hr />

<p>This is the xml file that is generated by XMLToCalcSupportFactory.</p>
<pre>&lt;?xml version="1.0" ?&gt;
&lt;DBDefinition&gt;

&lt;support name = "counterCalculator" factoryName = "org.epics.ioc.support.calc.example.CounterCalculatorFactory" /&gt;

&lt;support name = "arrayIncrementCalculator" factoryName = "org.epics.ioc.support.calc.example.ArrayIncrementCalculatorFactory" /&gt;

&lt;support name = "booleanArrayToggleCalculator" factoryName = "org.epics.ioc.support.calc.example.BooleanArrayToggleCalculatorFactory" /&gt;

&lt;support name = "arrayAddCalculator" factoryName = "org.epics.ioc.support.calc.example.ArrayAddCalculatorFactory" /&gt;
&lt;/DBDefinition&gt;
</pre>
<hr />

<h2 style="text-align: center" id="Generated">Generated Code</h2>
<hr />

<p>The following shows the java code generated by XMLToCalcSupportFactory.</p>

<h3 id="CounterCal">CounterCalculatorFactory.java</h3>
<pre>/* generated code */
package org.epics.ioc.support.calc.example;

import org.epics.ioc.support.calc.*;
import org.epics.ioc.db.*;
import org.epics.ioc.pv.*;
import org.epics.ioc.util.*;
import org.epics.ioc.process.*;
import org.epics.ioc.support.*;

public class CounterCalculatorFactory {
    public static Support create(DBStructure dbStructure) {
        return new CounterCalculator(dbStructure);
    }

    private static String supportName = "counterCalculator";

    private static class CounterCalculator extends AbstractCalculatorSupport
    {
        private CounterCalculator(DBStructure dbStructure) {
            super(supportName,dbStructure);
        }


        private ArgType[] argTypes = new ArgType[] {
            new ArgType("min",Type.pvDouble,null),
            new ArgType("max",Type.pvDouble,null),
            new ArgType("inc",Type.pvDouble,null)
        };
        private PVDouble minPV = null;
        private double min;
        private PVDouble maxPV = null;
        private double max;
        private PVDouble incPV = null;
        private double inc;

        private DBField valueDB = null;
        private PVDouble valuePV = null;
        private double value;

        public ArgType[] getArgTypes() { return argTypes;}

        public Type getValueType() { return Type.pvDouble;}

        public void setArgPVFields(PVField[] pvArgs) {
            minPV = (PVDouble)pvArgs[0];
            maxPV = (PVDouble)pvArgs[1];
            incPV = (PVDouble)pvArgs[2];
        };
        public void setValueDBField(DBField dbValue) {
            this.valueDB = dbValue;
            valuePV = (PVDouble)dbValue.getPVField();
        };

        public void process(SupportProcessRequester supportProcessRequester) {
            value = valuePV.get();
            min = minPV.get();
            max = maxPV.get();
            inc = incPV.get();
            compute();
            valuePV.put(value);
            valueDB.postPut();
            supportProcessRequester.supportProcessDone(RequestResult.success);
        }

        public void compute() {

            value += inc;
            if(inc&gt;0) {
                if(value&gt;max) value = min;
                if(value&lt;min) value = min;
            } else {
                if(value&gt;min) value = max;
                if(value&lt;max) value = max;
            }

        }
    }
}
</pre>

<h3 id="ArrayIncre">ArrayIncrementCalculatorFactory.java</h3>
<pre>/* generated code */
package org.epics.ioc.support.calc.example;

import org.epics.ioc.support.calc.*;
import org.epics.ioc.db.*;
import org.epics.ioc.pv.*;
import org.epics.ioc.util.*;
import org.epics.ioc.process.*;
import org.epics.ioc.support.*;

public class ArrayIncrementCalculatorFactory {
    public static Support create(DBStructure dbStructure) {
        return new ArrayIncrementCalculator(dbStructure);
    }

    private static String supportName = "arrayIncrementCalculator";

    private static class ArrayIncrementCalculator extends AbstractCalculatorSupport
    {
        private ArrayIncrementCalculator(DBStructure dbStructure) {
            super(supportName,dbStructure);
        }


        private ArgType[] argTypes = new ArgType[0];

        private DBField valueDB = null;
        private PVDoubleArray valuePV = null;
        private DoubleArrayData valueData = new DoubleArrayData();
        private double[] value;
        private int valueLength;

        public ArgType[] getArgTypes() { return argTypes;}

        public Type getValueType() { return Type.pvArray;}

        public void setArgPVFields(PVField[] pvArgs) {
        };

        public void setValueDBField(DBField dbValue) {
            this.valueDB = dbValue;
            valuePV = (PVDoubleArray)dbValue.getPVField();
        };
        public void process(SupportProcessRequester supportProcessRequester) {
            valueLength = valuePV.getLength();
            valuePV.get(0,valueLength,valueData);
            value = valueData.data;
            compute();
            valueDB.postPut();
            supportProcessRequester.supportProcessDone(RequestResult.success);
        }

        public void compute() {

           for(int i=0; i&lt;valueLength; i++) {
               value[i] = value[i] + 1.0;
           }

        }
    }
}
</pre>

<h3 id="BooleanArr">BooleanArrayToggleCalculatorFactory.java</h3>
<pre>/* generated code */
package org.epics.ioc.support.calc.example;

import org.epics.ioc.support.calc.*;
import org.epics.ioc.db.*;
import org.epics.ioc.pv.*;
import org.epics.ioc.util.*;
import org.epics.ioc.process.*;
import org.epics.ioc.support.*;

public class BooleanArrayToggleCalculatorFactory {
    public static Support create(DBStructure dbStructure) {
        return new BooleanArrayToggleCalculator(dbStructure);
    }

    private static String supportName = "booleanArrayToggleCalculator";

    private static class BooleanArrayToggleCalculator extends AbstractCalculatorSupport
    {
        private BooleanArrayToggleCalculator(DBStructure dbStructure) {
            super(supportName,dbStructure);
        }


        private ArgType[] argTypes = new ArgType[0];

        private DBField valueDB = null;
        private PVBooleanArray valuePV = null;
        private BooleanArrayData valueData = new BooleanArrayData();
        private boolean[] value;
        private int valueLength;

        public ArgType[] getArgTypes() { return argTypes;}

        public Type getValueType() { return Type.pvArray;}

        public void setArgPVFields(PVField[] pvArgs) {
        };

        public void setValueDBField(DBField dbValue) {
            this.valueDB = dbValue;
            valuePV = (PVBooleanArray)dbValue.getPVField();
        };

        public void process(SupportProcessRequester supportProcessRequester) {
            valueLength = valuePV.getLength();
            valuePV.get(0,valueLength,valueData);
            value = valueData.data;
            compute();
            valueDB.postPut();
            supportProcessRequester.supportProcessDone(RequestResult.success);
        }

        public void compute() {

             for(int i=0; i&lt;valueLength; i++) {
                 value[i] = (value[i] ? false : true);
             }

        }
    }
}
</pre>

<h3 id="ArrayAddCa">ArrayAddCalculatorFactory.java</h3>
<pre>/* generated code */
package org.epics.ioc.support.calc.example;

import org.epics.ioc.support.calc.*;
import org.epics.ioc.db.*;
import org.epics.ioc.pv.*;
import org.epics.ioc.util.*;
import org.epics.ioc.process.*;
import org.epics.ioc.support.*;

import java.lang.Math;

public class ArrayAddCalculatorFactory {
    public static Support create(DBStructure dbStructure) {
        return new ArrayAddCalculator(dbStructure);
    }

    private static String supportName = "arrayAddCalculator";

    private static class ArrayAddCalculator extends AbstractCalculatorSupport
    {
        private ArrayAddCalculator(DBStructure dbStructure) {
            super(supportName,dbStructure);
        }


        private ArgType[] argTypes = new ArgType[] {
            new ArgType("a",Type.pvArray,Type.pvDouble),
            new ArgType("b",Type.pvArray,Type.pvDouble)
        };
        private PVDoubleArray aPV = null;
        private DoubleArrayData aData = new DoubleArrayData();
        private double[] a;
        private int aLength;
        private PVDoubleArray bPV = null;
        private DoubleArrayData bData = new DoubleArrayData();
        private double[] b;
        private int bLength;

        private DBField valueDB = null;
        private PVDoubleArray valuePV = null;
        private DoubleArrayData valueData = new DoubleArrayData();
        private double[] value;
        private int valueLength;

        public ArgType[] getArgTypes() { return argTypes;}

        public Type getValueType() { return Type.pvArray;}

        public void setArgPVFields(PVField[] pvArgs) {
            aPV = (PVDoubleArray)pvArgs[0];
            bPV = (PVDoubleArray)pvArgs[1];
        };

        public void setValueDBField(DBField dbValue) {
            this.valueDB = dbValue;
            valuePV = (PVDoubleArray)dbValue.getPVField();
        };
        public void process(SupportProcessRequester supportProcessRequester) {
            valueLength = valuePV.getLength();
            valuePV.get(0,valueLength,valueData);
            value = valueData.data;
            aLength = aPV.getLength();
            aPV.get(0,aLength,aData);
            a = aData.data;
            bLength = bPV.getLength();
            bPV.get(0,bLength,bData);
            b = bData.data;
            compute();
            valueDB.postPut();
            supportProcessRequester.supportProcessDone(RequestResult.success);
        }

        public void compute() {

           int len = aLength;
           if(len&gt;bLength) len = bLength;
           if(valueLength!=len) {
               valueLength = len;
               valuePV.setLength(valueLength);
               valuePV.get(0,valueLength,valueData);
               value = valueData.data;
           }
           for(int i=0; i&lt;valueLength; i++) {
               value[i] = Math.abs(a[i] + b[i]);
           }

        }
    }
}
</pre>
</body>
</html>
