<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>EPICS JavaIOC: calculation support</title>
</head>

<body>
<h1 style="text-align: center">EPICS JavaIOC: support<br />
package: org.epics.ioc.support.calc<br />
2008.08.18</h1>
CONTENTS 

<div class="toc">
<ul>
  <li><a href="#Overview">Overview</a></li>
  <li><a href="#Basic">Basic Calculation Support</a>
    <ul>
      <li><a href="#Database">Database Definitions for Calculations</a></li>
      <li><a href="#Performing">Performing Calculations</a></li>
      <li><a href="#calcArgArr">calcArgArray</a></li>
    </ul>
  </li>
  <li><a href="#Expression">ExpressionCalculator</a>
    <ul>
      <li><a href="#Simple">Simple Examples</a></li>
      <li><a href="#Expression1">Expression Syntax</a></li>
      <li><a href="#Expression2">Expression Arguments</a></li>
      <li><a href="#Unary">Unary Operators</a></li>
      <li><a href="#Binary">Binary Operators</a></li>
      <li><a href="#Ternary">Ternary Operator</a></li>
      <li><a href="#Math">Math Functions</a></li>
      <li><a href="#Constant">Constant optimization</a></li>
      <li><a href="#Test">Test</a></li>
    </ul>
  </li>
  <li><a href="#XMLToCalcS">XMLToCalcSupport</a>
    <ul>
      <li><a href="#Introducti">Introduction</a></li>
      <li><a href="#Syntax">Syntax</a></li>
    </ul>
  </li>
</ul>
</div>
<hr />

<h2 style="text-align: center" id="Overview">Overview</h2>
<hr />

<p>This package provides support for calculations. A calculation computes a
result that is assigned to the value field. Three types of calculations are
supported by this package: </p>
<ol>
  <li>ExpressionCalulator<br />
    This is support for an expression that has the same syntax as a Java
    scalar expression. For example: 
    <pre>      a + b*c * Math.sin(d)
   </pre>
    For such expressions a complete expression factory is provided. </li>
  <li>XMLToCalcSupport<br />
    This is a factory that reads an xml file and produces a java class that
    implements a calculation. Initialization code is generated automatically.
  </li>
  <li>Basic Calculation Support<br />
    CalcArgArray support,AbstractCalculatorSupport, and the Database
    Definitions related to calculations. </li>
</ol>

<p>Basic calculation support is described first, then ExpressionCalculator,
and finally XMLToCalcSupport.</p>
<hr />

<h2 style="text-align: center" id="Basic">Basic Calculation Support</h2>
<hr />

<h3 id="Database">Database Definitions for Calculations</h3>

<p>dbd/structure/calx.xml defines the following:</p>
<pre>&lt;DBDefinition&gt;
  &lt;structure name = "calcArg" supportName = "generic" &gt;
  &lt;!-- instance must define value --&gt;
  &lt;field name = "name" type = "string" /&gt;
&lt;/structure&gt;

&lt;structure name = "expressionCalculator" supportName = "expressionCalculator" &gt;
  &lt;field name = "expression" type = "string" /&gt;
&lt;/structure&gt;

&lt;structure name = "calculation" supportName = "generic" &gt;
  &lt;field name = "calcArgArray" type = "array"
     elementType = "structure" supportName = "calcArgArray" /&gt;
  &lt;field name = "calculator" type = "structure" 
     structureName = "expressionCalculator" /&gt;
  &lt;field name = "alarm" type = "structure" structureName = "alarm" /&gt;
&lt;/structure&gt;

&lt;support name = "calcArgArray"
 factoryName = "org.epics.ioc.support.calc.CalcArgArrayFactory" /&gt;

&lt;support name = "expressionCalculator"
 factoryName = "org.epics.ioc.support.calc.ExpressionCalculatorFactory" /&gt;
&lt;/DBDefinition&gt;</pre>

<p><span style="font-family: courier">calculation</span> is the structure
used for calculations. The parent of <span
style="font-family: courier">calculation</span> must have a field with the
name <span style="font-family: courier">value</span> and must have a type
compatible with the calculator. </p>

<p>Structure <span style="font-family: courier">calculation</span> has the
fields: </p>
<dl>
  <dt><span style="font-family: courier">calcArgArray</span></dt>
    <dd>A field is an array of structures with each element being a <span
      style="font-family: courier">calcArg</span> structure and the support
      <span style="font-family: courier">calcArgArray</span>. If the
      calculator uses any arguments from calcArgArray this must be present
      and must have support. The support must complete before the support for
      calculator is called.</dd>
  <dt style="font-family: courier;">calculator</dt>
    <dd>This field has support that implements the calculation. The default
      support and structure name is expressionCalculator. This field must be
      present and must have support.</dd>
  <dt style="font-family: courier;">alarm</dt>
    <dd>This is present so that a record can be put in alarm if a calculation
      finds problems.</dd>
</dl>

<p><span style="font-family: courier">calcArg</span> is a structure that must
contain at least the fields:</p>
<dl>
  <dt><span style="font-family: courier">name</span></dt>
    <dd>The name of the argument. The <span
      style="font-family: courier">calculator</span> can use this field to
      associate <span style="font-family: courier">PVData</span> interfaces
      with expression arguments.</dd>
  <dt><span style="font-family: courier">value</span></dt>
    <dd>This must be defined in record instances with a type that is
      compatible with the expression.</dd>
  <dt>other</dt>
    <dd>Other fields can also be defined. For example a field named <span
      style="font-family: courier">input</span> can be defined as a structure
      with associated support that puts data into the <span
      style="font-family: courier">value</span> field.</dd>
</dl>

<p><span style="font-family: courier">expressionCalculator</span> is the
default structure for the <span
style="font-family: courier">calculator</span> field of structure <span
style="font-family: courier">calculation</span>. It is the structure required
by support <span style="font-family: courier">expressioncalculator</span>. It
has a single field:</p>
<dl>
  <dt><span style="font-family: courier">expression</span></dt>
    <dd>The expression using Java syntax.</dd>
  <dt></dt>
</dl>

<p>Support <span style="font-family: courier">calcArgArray</span> is the
support for field <span style="font-family: courier">calcArgArray</span>.
Support <span style="font-family: courier">expressionCalculator</span> is the
support described in the next section.</p>

<h3 id="Performing">Performing Calculations</h3>

<p>A calculation is performed by a calculation support. The following is
done. When the calculation support, which is generic, is called it calls the
calcArgArray support and the calculator support. For each element of
calcArgArray, the calcArgArray support calls The support for any subfields
that have support. The calcArgArray support extends Support to provide the
additional method <pre>    PVField getPVField(String argName);</pre>
which is used by the calculator support to get arguments. The calculator
support uses the calcArgArray values to compute the calculated value.</p>

<h3 id="calcArgArr">calcArgArray</h3>

<p>The support for a calcArgArray implements support for an array of calcArg
structures, which has the fields:</p>
<dl>
  <dt style="font-family: courier;">value</dt>
    <dd>A value for this argument. NOTE that record instnces must define
      value specifying the type.</dd>
  <dt style="font-family: courier;">name</dt>
    <dd>A string which provides a name for the argument.</dd>
  <dt style="font-family: courier;">other</dt>
    <dd>Other fields can be defined. For example a field input which is a
      link for obtaining the value for this argument. If no additional field
      specified then no input is read and the value field can just be set by
      the user.</dd>
</dl>
<hr />

<h2 style="text-align: center" id="Expression">ExpressionCalculator</h2>
<hr />

<p>This is support for an expression that has the form of a valid java
expression.</p>

<h3 id="Simple">Simple Examples</h3>

<p>The following example is a counter, i.e. each time the record is processed
the value field is incremented by 1.</p>
<pre>&lt;record name = "reallySimpleCounter"&gt; 
    &lt;value type = "byte"/&gt; 
    &lt;alarm structureName = "alarm" /&gt;
    &lt;timeStamp structureName = "timeStamp" /&gt;
    &lt;input structureName = "calculation" &gt;
      &lt;calculator&gt;
        &lt;expression&gt;value+1&lt;/expression&gt;
      &lt;/calculator&gt;
    &lt;/input&gt;
&lt;/record&gt;</pre>

<p>The following is an example that has arguments min, max, and inc. Each
time the record is processed the current value is incremented by inc. If the
result is less than or equal to max it becomes the new value; otherwise value
is set to max. Note that &lt; must be given as the xml escape sequence for
&lt; , i.e. &amp;lt;</p>
<pre>&lt;record name = "counter"&gt;
    &lt;alarm structureName = "alarm" /&gt;
    &lt;timeStamp structureName = "timeStamp" /&gt;
    &lt;value type = "double" /&gt;
    &lt;input structureName = "calculation" &gt;
      &lt;calcArgArray&gt;
        &lt;element structureName = "calcArg"&gt;
            &lt;value type = "double" &gt;0.0&lt;/value&gt;
            &lt;name&gt;min&lt;/name&gt;
        &lt;/element&gt;
        &lt;element structureName = "calcArg"&gt;
            &lt;value type = "double" &gt;10.0&lt;/value&gt;
            &lt;name&gt;max&lt;/name&gt;
        &lt;/element&gt;
        &lt;element structureName = "calcArg"&gt;
            &lt;value type = "double"&gt;0.5&lt;/value&gt;
            &lt;name&gt;inc&lt;/name&gt;
        &lt;/element&gt;
      &lt;/calcArgArray&gt;
      &lt;calculator&gt;
        &lt;expression&gt;(value+inc)&amp;lt;=max ? value+inc : min&lt;/expression&gt;
      &lt;/calculator&gt;
    &lt;/input&gt;
&lt;/record&gt;</pre>

<p>The next example computes the sin of an argument given in radians:</p>
<pre>&lt;record name = "sin"&gt;
    &lt;alarm structureName = "alarm" /&gt;
    &lt;timeStamp structureName = "timeStamp" /&gt;
    &lt;value type = "double" /&gt;
    &lt;input structureName = "calculation" &gt;
      &lt;calcArgArray&gt;
        &lt;element structureName = "calcArg"&gt;
            &lt;value type = "double" &gt;0.0&lt;/value&gt;
            &lt;name&gt;arg&lt;/name&gt;
        &lt;/element&gt;
      &lt;/calcArgArray&gt;
      &lt;calculator&gt;
        &lt;expression&gt;Math.sin(Math.PI*arg)&lt;/expression&gt;
      &lt;/calculator&gt;
    &lt;/input&gt;
&lt;/record&gt;</pre>

<p>The last example demonstrates the use of the ?: operator:</p>
<pre>&lt;record name = "check"&gt;
    &lt;alarm structureName = "alarm" /&gt;
    &lt;timeStamp structureName = "timeStamp" /&gt;
    &lt;value type = "boolean" /&gt;
    &lt;input structureName = "calculation" &gt;
      &lt;calcArgArray&gt;
        &lt;element structureName = "calcArg"&gt;
            &lt;value type = "byte" &gt;0&lt;/value&gt;
            &lt;name&gt;a&lt;/name&gt;
        &lt;/element&gt;
        &lt;element structureName = "calcArg"&gt;
            &lt;value type = "byte" &gt;1&lt;/value&gt;
            &lt;name&gt;b&lt;/name&gt;
        &lt;/element&gt;
      &lt;/calcArgArray&gt;
      &lt;calculator&gt;
        &lt;expression&gt;(a-b)==0 ? true : false&lt;/expression&gt;
      &lt;/calculator&gt;
    &lt;/input&gt;
&lt;/record&gt;</pre>

<h3 id="Expression1">Expression Syntax</h3>

<p>A expression is has the form of a valid Java scalar expression. The result
of the expression is assigned to the value field.</p>

<p>The precedence is the same as the Java precedence. For example the
following:</p>
<pre>   a + b*c + Math.sin(e*f)</pre>
Is the same as: 
<pre>   ((a + (b*c)) + Math.sin((e*f)))</pre>

<h3 id="Expression2">Expression Arguments</h3>

<p>An argument can be one of the following:</p>
<dl>
  <dt>variable</dt>
    <dd>The argument is one of the calcArgArray names.</dd>
  <dt>value</dt>
    <dd>The "value" appears as an argument than the argument is the value
      field itself.</dd>
  <dt>boolean constant</dt>
    <dd>The argument is "true" or "false"</dd>
  <dt>string constant</dt>
    <dd>A argument enclosed in "" is a string constant.</dd>
  <dt>integer constand</dt>
    <dd>The argument is a valid java integer constant.i It becomes an int
      constant unless it is terminated with the character L, which means it
      is a long integer constant. The value can also be given as a valid hex
      integer, e.g. 0x0fff. </dd>
  <dt>real constant</dt>
    <dd>The argument is a valid java real constant, i.e. it is either a float
      or double constant.</dd>
  <dt>Math constant</dt>
    <dd>The argument is either Math.PI or Math.E</dd>
</dl>

<h3 id="Unary">Unary Operators</h3>

<p>The supported unary operators are:</p>
<dl>
  <dt>+</dt>
    <dd>Unary plus. The argument can be any numeric type.</dd>
  <dt>-</dt>
    <dd>Unary minus. The argument can be any numeric type.</dd>
  <dt>~</dt>
    <dd>Bitwise Complement. The argument can be any integer type.</dd>
  <dt>!</dt>
    <dd>Boolean not. The argument must be boolean.</dd>
</dl>

<h3 id="Binary">Binary Operators</h3>

<p>The supported binary operators are:</p>
<dl>
  <dt>*</dt>
    <dd>Multiplication. The argument can be any numeric type.</dd>
  <dt>/</dt>
    <dd>Division. The argument can be any numeric type.</dd>
  <dt>%</dt>
    <dd>Remainder. The argument can be an integer type.</dd>
  <dt>+</dt>
    <dd>Binary plus. The arguments can be any numeric type.</dd>
  <dt>+</dt>
    <dd>String concatenation. The first argument must be a string.</dd>
  <dt>-</dt>
    <dd>Binary minus. The arguments can be any numeric type.</dd>
  <dt>&lt;&lt;</dt>
    <dd>Left shift. The arguments must be an integer type.</dd>
  <dt>&gt;&gt;</dt>
    <dd>Right shift sign extended. The arguments must be an integer type.</dd>
  <dt>&gt;&gt;&gt;</dt>
    <dd>Right shift zero extended. The arguments must of an integer type.</dd>
  <dt>&lt;</dt>
    <dd>Less than. The arguments must be numeric.</dd>
  <dt>&lt;=</dt>
    <dd>Less than or equal. The arguments must be numeric.</dd>
  <dt>&gt;</dt>
    <dd>Greater than. The arguments must be numeric.</dd>
  <dt>&gt;=</dt>
    <dd>Greater than or equal. The arguments must be numeric.</dd>
  <dt>==</dt>
    <dd>Equal. The arguments can be any supported type.</dd>
  <dt>!=</dt>
    <dd>Not equal. The arguments can be any supported type.</dd>
  <dt>&amp; </dt>
    <dd>Integer and. The arguments must be integer.</dd>
  <dt>&amp; </dt>
    <dd>Boolean and. The arguments must be boolean.</dd>
  <dt>^</dt>
    <dd>Bitwise XOR. The arguments must be integer.</dd>
  <dt>^</dt>
    <dd>Boolean XOR. The arguments must be boolean.</dd>
  <dt>|</dt>
    <dd>Bitwise or. The arguments must be integer.</dd>
  <dt>|</dt>
    <dd>Boolean or. The arguments must be boolean.</dd>
  <dt>&amp;&amp;</dt>
    <dd>Conditional and. The arguments must be boolean.</dd>
  <dt>||</dt>
    <dd>Conditional or. The arguments must be boolean.</dd>
</dl>

<h3 id="Ternary">Ternary Operator</h3>

<p>The ternary operator ?: is supported.</p>

<h3 id="Math">Math Functions</h3>

<p>All the functions defined in java.lang.Math are supported.</p>

<h3 id="Constant">Constant optimization</h3>

<p>If the arguments of an operator are all constants then the result is
determioned during initialization and the operation not performed when the
record is processed.</p>

<h3 id="Test">Test</h3>

<p>test/calc contains tests for ExpressionCalculator. After the test is
initialized use the swtshell to bring up the introspectDatabase screen.
Select the showBadRecordss button. No records should appear except possibly
active records. The only records without checks are random,
calcSimpleCounter, and calcCounter. These can be checked manually. For random
issue get with process requests. For calcSimpleCounter and calcCounter just
monitor the records.</p>
<hr />

<h2 style="text-align: center" id="XMLToCalcS">XMLToCalcSupport</h2>
<hr />

<h3 id="Introducti">Introduction</h3>

<p>This is a utility that generates a CalculatorSupport module from an xml
formated file. It accepts a single argument that provides the name, including
the path, of the xml file with syntex described below. The file name must we
of the form xxxGenerate.xml. The output appears in the same directory as the
xxxGenerate.xml file. A java file is generated for each calculate defined in
xxxGenerate.xml file and also a file named xxxSupport.xml. The xxxSupport.xml
file contains a Database Support definition for each of the calculate support
modules. For an example look at the files in
org.epics.ioc.support.calc.example. Except for exampleCalculatorGenerate.xml,
the files in this package were generated by executing XMLToCalcSupport with
the argument</p>
<pre>    src/org/epics/ioc/support/calc/example/exampleCalculatorGenerate.xml</pre>

<h3 id="Syntax">Syntax</h3>

<p>An xml file for XMLToCalcSupport has the following syntax</p>
<pre>&lt;?xml version="1.0" ?&gt;
&lt;JavaIOCCalculation&gt;

&lt;calculate name = "name"&gt;
  &lt;import packageName = "name" /&gt;
  &lt;arg name = "name" type = "type" elementType = "type" /&gt;
  &lt;value type = "type" elementType = "type" /&gt;
  &lt;compute&gt;
           &lt;!-- java code --&gt;
  &lt;/compute&gt;
  &lt;process&gt;
          &lt;!-- java code --&gt;
&lt;/calculate&gt;</pre>

<p>Where the tags are:</p>
<dl>
  <dt style="font-family: courier;">calculate</dt>
    <dd>Each calculate definition produces a java file with the name
      "&lt;name&gt;CalculatorFactory.java". The only attribute is: 
      <dl>
        <dt>name</dt>
          <dd>The name of the module to be generated.</dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">import</dt>
    <dd>Each import statement becomes a java import statement in the
      generated file.<br />
      The only attribute is: 
      <dl>
        <dt>name</dt>
          <dd>The package name, e.g. java.lang.math</dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">arg</dt>
    <dd>Each generates code for an argument. Details are given below.<br />
      The attributes are: 
      <dl>
        <dt>name</dt>
          <dd>The name of the argument.</dd>
        <dt>type</dt>
          <dd>The argument type. All pv types except structure are
          supported.</dd>
        <dt>elementType</dt>
          <dd>If the type is array this specifies the element type. All types
            are supported except array and structure. </dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">value</dt>
    <dd>Each generates code for the computed value. Details are given
      below.<br />
      The attributes are: 
      <dl>
        <dt>type</dt>
          <dd>The value type.i All pv types except structure are
          supported.</dd>
        <dt>elementType</dt>
          <dd>If the type is array this specifies the element type. All types
            are supported except array and structure. </dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">compute</dt>
    <dd>This is the code for method compute. Often this is the only code that
      needs to be defined in order to create a calculation module. </dd>
  <dt style="font-family: courier;">process</dt>
    <dd>This is the code for process. If not given a default process method
      is generated that gets the argument values and the value value, calls
      compute, and outputs the value and calls dbPost. </dd>
</dl>
</body>
</html>
