<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>EPICS JavaIOC: calculation support</title>
</head>

<body>
<h1 style="text-align: center">EPICS JavaIOC: support<br />
package: org.epics.ioc.support.calc<br />
2008.06.27</h1>
CONTENTS 

<div class="toc">
<ul>
  <li><a href="#Overview">Overview</a></li>
  <li><a href="#Calculatio">Calculation Support</a>
    <ul>
      <li><a href="#Database">Database Definitions for Calculations</a></li>
      <li><a href="#Performing">Performing Calculations</a></li>
      <li><a href="#calcArgArr">calcArgArray</a></li>
      <li><a href="#Calculator">Calculator</a></li>
    </ul>
  </li>
  <li><a href="#XMLToCalcS">XMLToCalcSupport</a>
    <ul>
      <li><a href="#Introducti">Introduction</a></li>
      <li><a href="#Syntax">Syntax</a></li>
    </ul>
  </li>
</ul>
</div>
<hr />

<h2 style="text-align: center" id="Overview">Overview</h2>
<hr />

<p>The following interfaces are available:</p>
<dl>
  <dt>CalculatorSupport</dt>
    <dd>An extension for field calculations.</dd>
  <dt>CalcArgArraySupport</dt>
    <dd>An extension for the arguments for calculations;</dd>
</dl>

<p>The following abstract classes are provided for implementing support:</p>
<dl>
  <dt>AbstractCalculatorSupport</dt>
    <dd>A base class that is extended by code generated by
    XMLToCalcSupport.</dd>
</dl>

<p>The following factories are provided:</p>
<dl>
  <dt>CalcArgArrayFactory</dt>
    <dd>Support for an array of arguments for calculation records.</dd>
  <dt>XMLToCalcSupport</dt>
    <dd>Generates an imnplementation of CalculatorSupport.</dd>
</dl>
<hr />

<h2 style="text-align: center" id="Calculatio">Calculation Support</h2>
<hr />

<p>Support is provided for performing calculations. Currently there is no
generic calculation support similar to calcPerform.c that is part of EPICS
V3. A calculation support module could be implemented that provides similar
functionality. A support module is available for field calcArgArray. A
structure that supports calculations normally has the fields:</p>
<dl>
  <dt style="font-family: courier;">value</dt>
    <dd>It must be a field named in the parent of the calculation field. This
      field is assigned a value by the calculation module and must have a
      type compatible with the calculator. </dd>
  <dt style="font-family: courier;">calcArgArray</dt>
    <dd>The calcArgArray field is normally an array of structures with each
      element being a calcArg structure and the support for calcArgArray is
      the calcArgArray support described in
      org.epics.ioc.support.CalcArgArraySupport. This field must be present
      and must have support. The support must complete before the support for
      calculator is called.</dd>
  <dt style="font-family: courier;">calculator</dt>
    <dd>This field is normally a link that has support that implements the
      calculation. org.epics.ioc.support.CounterCalculationFactory provides
      an example. This field must be present and must have support. The
      support must complete before the support for valueAlarm is called.</dd>
</dl>

<h3 id="Database">Database Definitions for Calculations</h3>

<p>This is example support for use with the calcDouble record or structure.
File calcDoubleCommon.xml defines the fields:</p>
<pre>&lt;DBDefinition&gt;
  &lt;field name = "value" type = "double" /&gt;
  &lt;field name = "calcArgArray" type = "array"
     elementType = "structure" supportName = "calcArgArray" /&gt;
  &lt;field name = "calculator" type = "structure" /&gt;
  &lt;field name = "alarm" type = "structure"/&gt;
  &lt;field name = "timeStamp" type = "structure" /&gt;  
  &lt;field name = "input" type = "structure" /&gt;
  &lt;!-- instance can set structureName = "doubleAlarm" --&gt;
  &lt;field name = "valueAlarm" type = "structure" /&gt;
  &lt;field name = "output" type = "structure" /&gt;
  &lt;field name = "display" type = "structure" /&gt;
  &lt;field name = "control" type = "structure"/&gt;
  &lt;!-- instance can set structureName = "doubleHistory" --&gt;
  &lt;field name = "history" type = "structure" /&gt;
&lt;/DBDefinition&gt;</pre>

<p>Field calcDoubleRecord.xml defines:</p>
<pre>&lt;structure name = "calcDoubleArg" &gt;
  &lt;field name = "value" type = "double" /&gt;
  &lt;field name = "name" type = "string" /&gt;
  &lt;field name = "input" type = "structure" /&gt;
&lt;/structure&gt;

&lt;structure name = "calcDouble" supportName = "generic" &gt;
  &lt;include href = "calcDoubleCommon.xml" /&gt;
&lt;/structure&gt;

&lt;recordType name = "calcDouble" supportName = "generic" &gt;
  &lt;include href = "common.xml" /&gt;
  &lt;include href = "calcDoubleCommon.xml" /&gt;
  &lt;field name = "supportArray" type = "array"
     elementType = "structure" supportName = "supportArray" /&gt;
&lt;/recordType&gt;</pre>

<p>The following support is defined in calc.xml</p>
<pre>&lt;support name = "calcArgArray"
 factoryName = "org.epics.ioc.support.CalcArgArrayFactory" /&gt;</pre>

<h3 id="Performing">Performing Calculations</h3>

<p>A calculation is performed by a calculation link support. The following is
done. When the calcRecord support is called it calls the calcArgArray support
and when it completes the calculation link support. For each element if the
calcArgArray, the calcArgArray support calls the input link support (if it is
specified) to get the calcArg value. The calculation support uses the
calcArgArray values to compute the calculated value. At present generic
calculation support is not implemented. It is envisioned that it will allow
the user to enter expressions like. The calcArgArray would have two elements
with calcArg.name set to.</p>

<h3 id="calcArgArr">calcArgArray</h3>

<p>The support for a calcArgArray implements support for an array of calcArg
structures, which has the fields:</p>
<dl>
  <dt style="font-family: courier;">value</dt>
    <dd>A value for this argument.</dd>
  <dt style="font-family: courier;">name</dt>
    <dd>A string which provides a name for the argument.</dd>
  <dt style="font-family: courier;">input</dt>
    <dd>A link for obtaining the value for this argument. Note that if no
      support is specified then no input is read and the value field can just
      be set by the user.</dd>
</dl>

<p>calcArgArray uses the following definitions:</p>
<pre>    public interface CalcArgArraySupport extends Support{
        PVField getPVField(String argName);
    }

    public class CalcArgArrayFactory {
        public static Support create(DBField dbField);
    }</pre>

<p>CalcArgArraySupport extends Support to provide the method:</p>
<dl>
  <dt style="font-family: courier;">getPVField</dt>
    <dd>This is a convience metod for calculator support. It looks in the
      calcArgArray for a field with the specified name and returns it's
      interface.</dd>
</dl>

<h3 id="Calculator">Calculator</h3>

<p>Support for a calculation field, which is a link, must implement:</p>
<pre>    public interface CalculatorSupport extends Support {
        void setCalcArgArraySupport(CalcArgArraySupport calcArgArraySupport);
    }</pre>

<p>CalculatorSupport extends Support to add the method:</p>
<dl>
  <dt style="font-family: courier;">setCalcArgArraySupport</dt>
    <dd>This is called by calcDoubleRecord support.</dd>
</dl>
<hr />

<h2 style="text-align: center" id="XMLToCalcS">XMLToCalcSupport</h2>
<hr />

<h3 id="Introducti">Introduction</h3>

<p>This is a utility that generates a CalculatorSupport module from an xml
formated file. It accepts a single argument that provides the name, including
the path, of the xml file with syntex described below. The file name must bwe
of the form xxxGenerate.xml. It generates it's output in the same directory
where the xxxGenerate.xml file appears. It generates a java file for each
calculate defined in the xxxGenerate.xml file and also generates as file
named xxxSupport.xml. The xxxSupport.xml file contains a Database Support
definition for each of the calculate support modules. For an example look at
the files in org.epics.ioc.support.calc.example. Except for
exampleCalculatorGenerate.xml, the files in this package were generated by
executing XMLToCalcSupport with the argument</p>
<pre>    src/org/epics/ioc/support/calc/example/exampleCalculatorGenerate.xml</pre>

<h3 id="Syntax">Syntax</h3>

<p>An xml file for XMLToCalcSupport has the following syntax</p>
<pre>&lt;?xml version="1.0" ?&gt;
&lt;JavaIOCCalculation&gt;

&lt;calculate name = "name"&gt;
  &lt;import packageName = "name" /&gt;
  &lt;arg name = "name" type = "type" elementType = "type" /&gt;
  &lt;value type = "type" elementType = "type" /&gt;
  &lt;compute&gt;
           &lt;!-- java code --&gt;
  &lt;/compute&gt;
  &lt;process&gt;
          &lt;!-- java code --&gt;
&lt;/calculate&gt;</pre>

<p>Where the tags are:</p>
<dl>
  <dt style="font-family: courier;">calculate</dt>
    <dd>Each calculate definition produces a java file with the name
      "&lt;name&gt;CalculatorFactory.java". The only attribute is: 
      <dl>
        <dt>name</dt>
          <dd>The name of the module to be generated.</dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">import</dt>
    <dd>Each import statement becomes a java import statement in the
      generated file.<br />
      The only attribute is: 
      <dl>
        <dt>name</dt>
          <dd>The package name, e.g. java.lang.math</dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">arg</dt>
    <dd>Each generates code for an argument. Details are given below.<br />
      The attributes are: 
      <dl>
        <dt>name</dt>
          <dd>The name of the argument.</dd>
        <dt>type</dt>
          <dd>The argument type. All pv types except structure are
          supported.</dd>
        <dt>elementType</dt>
          <dd>If the type is array this specifies the element type. All types
            are supported except array and structure. </dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">value</dt>
    <dd>Each generates code for the computed value. Details are given
      below.<br />
      The attributes are: 
      <dl>
        <dt>type</dt>
          <dd>The value type.i All pv types except structure are
          supported.</dd>
        <dt>elementType</dt>
          <dd>If the type is array this specifies the element type. All types
            are supported except array and structure. </dd>
      </dl>
    </dd>
  <dt style="font-family: courier;">compute</dt>
    <dd>This is the code for method compute. Often this is the only code that
      needs to be defined in order to create a calculation module. </dd>
  <dt style="font-family: courier;">process</dt>
    <dd>This is the code for process. If not given a default process method
      is generated that gets the argument values and the value value, calls
      compute, and outputs the value and calls dbPost. </dd>
</dl>
</body>
</html>
