<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>EPICS JavaIOC: portDriver support</title>
</head>

<body>
<h1 style="text-align: center">EPICS JavaIOC: support<br />
package: org.epics.ioc.support.pdrv<br />
2010.01.26</h1>
CONTENTS 

<div class="toc">
<ul>
  <li><a href="#Overview">Overview</a></li>
  <li><a href="#portDriver">portDriverLink</a></li>
  <li><a href="#portDriver1">portDriverSupport</a></li>
  <li><a href="#Support">Support for PortDriverLink</a></li>
  <li><a href="#Port">Port Creation</a></li>
  <li><a href="#Port1">Port and Device Control</a></li>
</ul>
</div>
<hr />

<h2 style="text-align: center" id="Overview">Overview</h2>
<hr />

<p>This package contains the general purpose code for support that
communicates with a portDriver. The actual support code, which extends code
supplied by this package, resides in subpackages. This package provides the
following:</p>
<dl>
  <dt>portDriverLink</dt>
    <dd>The complete support for a portDriverLink, which is described
    below.</dd>
  <dt>portDriverSupport</dt>
    <dd>The interface definition for PortDriverSupport and an abstract base
      class, which is extended by code that communicates with a
    portDriver.</dd>
  <dt>portCreate</dt>
    <dd>The complete support for creating port drivers via JavaIOC
    records.</dd>
  <dt>portDeviceControl</dt>
    <dd>The complete support for a JavaIOC record that controls a port and
      device.</dd>
</dl>

<p>A portDriverLink is a structure field that links to a portDriver. The
structure can have an arbitrary number of fields with support that
communicates with the portDriver. A field of a portDriverLink must not have
other types of support. The support for portDriverLink allocates a User and
connects to a port and to a device.</p>

<p>When a portDriverLink is processed it does the following for each subfield
of the portDriverLink structure. It first calls beginProcess for each
PortDriverSupport. It then calls user.queueRequest. When it is called back,
it calls the queueCallback of each PortDriverSupport. When the last returns
it calls processContinue. When it is called back, it calls the endProcess
method of each PortDriverSupport. It then completes processing.</p>

<p>Thus with one queueRequest multiple PortDriverSupports can access the
portDriver. An example of how this is used is serial support. Consider the
following example:</p>
<pre>&lt;record name = "intToSerial"&gt;
    &lt;scalar name = "value" type = "int"&gt;1000&lt;/scalar&gt;
    &lt;structure name = "alarm" type = "alarm" /&gt;
    &lt;structure name = "timeStamp" type = "timeStamp" /&gt;
    &lt;structure name = "link" type = "portDriverLink"&gt;
        &lt;scalar name = "portName"&gt;serialPort&lt;/scalar&gt;
        &lt;scalar name = "deviceName"&gt;3&lt;/scalar&gt;
        &lt;scalar name = "timeout"&gt;.2&lt;/scalar&gt;
        &lt;structure name = "command" type = "pdrvScalarCommand"&gt;
            &lt;scalar name = "prefix"&gt;:VOLT:DC:RANG:UPP&lt;/scalar&gt;
            &lt;structure name = "output" type = "pdrvSerialOutput"/&gt;
        &lt;/structure&gt;
        &lt;structure name = "discardResponse" type = "pdrvStringNoop"&gt;
            &lt;structure name = "query" type = "pdrvScalarQuery"&gt;
                &lt;scalar name = "request"&gt;:VOLT:DC:RANG:UPP?&lt;/scalar&gt;
                &lt;structure name = "output" type = "pdrvSerialOutput"/&gt;
                &lt;structure name = "input" type = "pdrvSerialInput"/&gt;
            &lt;/structure&gt;
        &lt;/structure&gt;
    &lt;/structure&gt;
&lt;/record&gt;</pre>

<p>The field named link is a portDriverLink. The structures of type
pdrvScalarCommand, pdrvSerialOutput, pdrvStringNoop, pdrvSerialOutput, and
pdrvSerialInput are all PortDriverSupport code implemented in subpackage
serial. The link support code calls the support for pdrvScalarCommand and for
pdrvStringNoop.</p>

<p>pdrvScalarCommand creates a string that is the prefix followed by
intToSerial.value converted to a string when is field
intToSerial.link.command.command. It then calls the support for
pdrvSerialOutput. Thus the string sent to the portDriver is
":VOLT:DC:RANG:UPP 1000"</p>

<p>pdrbStringNoop calls the support for pdrvScalarQuery, which calls
pdrvSerialOutput and then pdrvSerialInput. The end result is that the string
value "1010.000000" appears in field
intToSerial.link.discardResponse.query.response. I do not know why this
instrument returned this value instead of 1000.</p>
<hr />

<h2 style="text-align: center" id="portDriver">portDriverLink</h2>
<hr />

<p>The xml definition for structure portDriverLink is:</p>
<pre>&lt;structure name = "portDriverLinkFactory"&gt;
  &lt;scalar name = "supportFactory" type = "string"&gt;
     org.epics.ioc.support.pdrv.PortDriverLinkFactory&lt;/scalar&gt;
&lt;/structure&gt;

&lt;structure name = "portDriverLink"&gt;
  &lt;auxInfo name = "supportFactory" type = "string"&gt;portDriverLinkFactory&lt;/auxInfo&gt;
  &lt;scalar name = "portName" type = "string" /&gt;
  &lt;scalar name = "deviceName" type = "string" /&gt;
  &lt;!-- timeout only used for asynchronous ports --&gt;
  &lt;scalar name = "timeout" type = "double"&gt;1.0&lt;/scalar&gt;
  &lt;structure name = "alarm" type = "alarm" /&gt;
&lt;/structure&gt;

&lt;structure name = "portDriverInterruptLink"&gt;
  &lt;scalar name = "portName" type = "string" /&gt;
  &lt;scalar name = "deviceName" type = "string" /&gt;
&lt;/structure&gt;</pre>

<p>An interrupt link is for support code that receives portDriver interrupts.
This support code does not make read/write requests to a portDriver, rather
it is called by portDriver interrupts. This it is handled completely
different than a portDriverLink. </p>

<p>The Java defininitions are:</p>
<pre>interface PortDriverLink {
    User getUser();
    AlarmSupport getAlarmSupport();
    byte[] getByteBuffer();
    byte[] expandByteBuffer(int size);
}

public class PortDriverLinkFactory {
    public static Support create(PVStructure pvStructure);
}

public abstract class AbstractPortDriverInterruptLink extends AbstractSupport
implements RecordProcessRequester,QueueRequestCallback
{
    protected AbstractPortDriverInterruptLink(String supportName,PVStructure pvStructure) ;
    protected static Convert convert = ConvertFactory.getConvert();
    protected static PVProperty pvProperty = PVPropertyFactory.getPVProperty();
    protected String supportName;
    protected PVStructure pvStructure;
    protected String fullName = null;
    protected PVRecord pvRecord = null;
    protected String recordName = null;
    protected RecordProcess recordProcess = null;
    protected PVField valuePVField = null;
    protected AlarmSupport alarmSupport = null;
    protected PVString pvPortName = null;
    protected PVString pvDeviceName = null;
    protected PVBoolean pvProcess = null;
    protected User user = null;
    protected Port port = null;
    protected Trace portTrace = null;
    protected Device device = null;
    protected Trace deviceTrace = null;
    protected SupportProcessRequester supportProcessRequester = null;

    public void initialize(RecordSupport recordSupport);
    public void uninitialize();
    public void start();
    public void stop();

    public boolean isProcess();
    public void callback(Status status, User user);
    public void recordProcessComplete();
    public void recordProcessResult(RequestResult requestResult) {}
}</pre>
<hr />

<h2 style="text-align: center" id="portDriver1">portDriverSupport</h2>
<hr />

<p>AbstractPortDriverSupport is the base class for all non-interrupt
PortDriverSupport code. It does most initialization required by support code
and, very important, it calls beginProcess, queueCallback, and endProcess for
subfields of the structure it supports. The Java defininitions are:</p>
<pre>interface PortDriverSupport extends Support {
    void setPortDriverLink(PortDriverLink portDriverLink);
    void beginProcess();
    void endProcess();
    void queueCallback();
}

public abstract class AbstractPortDriverSupport extends GenericBase
implements PortDriverSupport
{
    protected AbstractPortDriverSupport(String supportName,PVStructure pvStructure);
    protected static Convert convert = ConvertFactory.getConvert();
    protected static PVProperty pvProperty = PVPropertyFactory.getPVProperty();
    protected static final String emptyString = "";
    protected String supportName;
    protected PVStructure pvStructure;
    protected PVRecord pvRecord = null;
    protected String recordName = null;
    protected String fullName = null;
    protected PVField valuePVField = null;
    protected AlarmSupport alarmSupport = null;
    protected PortDriverLink portDriverLink = null;
    protected User user = null;
    protected Port port = null;
    protected Device device = null;
    protected Trace portTrace = null;
    protected Trace deviceTrace = null;
    protected SupportProcessRequester supportProcessRequester = null;

    public void setPortDriverLink(PortDriverLink portDriverLink);

    public void initialize(RecordSupport recordSupport);
    public void uninitialize();
    public void start();
    public void stop();
    public void process(SupportProcessRequester supportProcessRequester);

    public void beginProcess();
    public void endProcess();
    public void queueCallback();
    public void message(String message,MessageType messageType)
}</pre>
<hr />

<h2 style="text-align: center" id="Support">Support for PortDriverLink</h2>
<hr />

<p>Again this package has the complete implementation of PortDriverLink. The
Java defininition is:</p>
<pre>public class PortDriverLinkFactory {
    public static Support create(PVStructure pvStructure);
}</pre>
<hr />

<h2 style="text-align: center" id="Port">Port Creation</h2>
<hr />

<p>A portDriver instance is created via JavaIOC database records that are
created with type "portCreate". A field named "driverParameters" is a
structure containing driver specific confifuration information. The xml
definition for structure portCreate is:</p>
<pre>&lt;structure name = "portCreateFactory"&gt;
  &lt;scalar name = "supportFactory" type = "string"&gt;
     org.epics.ioc.support.pdrv.PortCreateFactory&lt;/scalar&gt;
&lt;/structure&gt;

&lt;structure name = "portCreate"&gt;
  &lt;auxInfo name = "supportFactory" type = "string"&gt;portCreateFactory&lt;/auxInfo&gt;
  &lt;scalar name = "factoryName" type = "string" /&gt;
  &lt;scalar name = "portName" type = "string" /&gt;
  &lt;scalar name = "autoConnect" type = "boolean"&gt;true&lt;/scalar&gt;
  &lt;structure name = "priority" type = "scanPriority" /&gt;
&lt;/structure&gt;</pre>

<p>An example is:</p>
<pre>&lt;record name = "serialPort" type = "portCreate"&gt;
    &lt;scalar name = "factoryName"&gt;org.epics.ioc.pdrv.vxi11.DriverFactory&lt;/scalar&gt;
    &lt;scalar name = "portName"&gt;serialPort&lt;/scalar&gt;

    &lt;structure name = "driverParameters" type = "vxi11Driver" &gt;
        &lt;scalar name = "hostName"&gt;192.168.1.10&lt;/scalar&gt;
        &lt;scalar name = "vxiName"&gt;hpib&lt;/scalar&gt;
    &lt;/structure&gt;
&lt;/record&gt;</pre>

<p>The Java defininition for the factory is:</p>
<pre>public class PortCreateFactory {
    public static Support create(PVStructure pvStructure);
}</pre>
<hr />

<h2 style="text-align: center" id="Port1">Port and Device Control</h2>
<hr />

<p>A record instance can be created for a port and device instance. This
record can be used to control options for the port and device. Since these
options can be set after start, they will occur before any records are
processed. For example trace options can be set before the first connect call
isissued. The xml definition for structure portDeviceControl is:</p>
<pre>&lt;structure name = "portDeviceControlFactory"&gt;
  &lt;scalar name = "supportFactory" type = "string"&gt;
     org.epics.ioc.support.pdrv.PortDeviceControlFactory&lt;/scalar&gt;
&lt;/structure&gt;

&lt;structure name = "portDeviceControl"&gt;
  &lt;auxInfo name = "supportFactory" type = "string"&gt;portDeviceControlFactory&lt;/auxInfo&gt;
  &lt;scalar name = "message" type = "string" /&gt;
  &lt;scalar name = "portName" type = "string" /&gt;
  &lt;scalar name = "deviceName" type = "string" /&gt;
  &lt;scalar name = "processAtStart" type = "boolean"&gt;false&lt;/scalar&gt;
  &lt;scalar name = "connect" type = "boolean"&gt;false&lt;/scalar&gt;
  &lt;scalar name = "enable" type = "boolean"&gt;true&lt;/scalar&gt;
  &lt;scalar name = "autoConnect" type = "boolean"&gt;truer&lt;/scalar&gt;
  &lt;scalar name = "traceMask" type = "int"&gt;1&lt;/scalar&gt;
  &lt;scalar name = "traceIOMask" type = "int"&gt;0&lt;/scalar&gt;
  &lt;scalar name = "traceIOTruncateSize" type = "int"&gt;80&lt;/scalar&gt;
  &lt;scalar name = "report" type = "boolean"&gt;false&lt;/scalar&gt;
  &lt;scalar name = "reportDetails" type = "int"&gt;3&lt;/scalar&gt;
&lt;/structure&gt;</pre>

<p>An example is:</p>
<pre>&lt;record name = "serialDeviceControl" type = "portDeviceControl" &gt;
    &lt;scalar name = "portName"&gt;serialPort&lt;/scalar&gt;
    &lt;scalar name = "deviceName"&gt;3&lt;/scalar&gt;
    &lt;scalar name = "traceMask"&gt;0xfff&lt;/scalar&gt;
    &lt;scalar name = "traceIOMask"&gt;0xfff&lt;/scalar&gt;
    &lt;scalar name = "processAtStart"&gt;true&lt;/scalar&gt;
&lt;/record&gt;</pre>

<p>The Java defininitions are:</p>
<pre>public class PortDeviceControlFactory {
    public static Support create(PVStructure pvStructure);
}</pre>
</body>
</html>
